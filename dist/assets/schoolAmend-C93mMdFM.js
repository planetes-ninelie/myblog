import{_ as E,r as c,o as p,c as g,g as n,w as d,F as L,a as b,f as v,q as f,p as R,l as S,e as F,b as V,t as I}from"./index-NR-jAZ8C.js";const A={data(){var o=(s,t,r)=>{t===""?r(new Error("请填写管理员账号")):r()},l=(s,t,r)=>{t.length<6&&t.length>0||t.length>20?r(new Error("请输入6-20位的密码")):(this.ruleForm.checkPass!==""&&this.$refs.ruleForm.validateField("checkPass"),r())},i=(s,t,r)=>{t!==this.ruleForm.password?r(new Error("两次输入密码不一致!")):r()},u=(s,t,r)=>{!/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((.[a-zA-Z0-9_-]{2,3}){1,2})$/.test(t)&&t?r(new Error("邮箱格式不正确！")):r()},e=(s,t,r)=>{!/^1[0-9]{10}$/.test(t)&&t?r(new Error("手机号码格式不正确！")):r()};return{ruleForm:{username:"",password:"",checkPass:"",mobile:"",email:"",status:0,roleIdList:[],schoolDtoList:[],roleType:null},roleList:[],manageRegionList:[],rules:{username:[{validator:o,trigger:"blur"}],password:[{validator:l,trigger:"blur"}],checkPass:[{validator:i,trigger:"blur"}],roleIdList:[{type:"array",required:!0,message:"请至少选择一个所属角色",trigger:"change"}],email:[{validator:u,trigger:"blur"}],mobile:[{validator:e,trigger:"blur"}]},enableRegion:!0,isBranch:!0}},methods:{submitForm(o){this.$refs[o].validate(async(l,i)=>{if(l){let u="";try{this.ruleForm.schoolDtoList=[],await this.manageRegionList.forEach(s=>{if(s.all||s.isIndeterminate){console.log(s);let t={};if(this.ruleForm.roleIdList[0]==="校区管理员"){let r=[];s.campusIdList.forEach(m=>{r.push({id:m})}),t={id:s.id,schoolCampusDto:r}}this.ruleForm.roleIdList[0]==="学校管理员"&&(t={id:s.id}),this.ruleForm.schoolDtoList.push(t)}}),this.ruleForm.status=this.ruleForm.status?1:0,this.ruleForm.userId=+this.$route.query.userId,await this.roleList.forEach(s=>{s.roleName===this.ruleForm.roleIdList[0]&&(this.ruleForm.roleIdList[0]=s.roleId)}),delete this.ruleForm.checkPass;for(let s in this.ruleForm)(this.ruleForm[s]===void 0||this.ruleForm[s]===null)&&delete this.ruleForm[s];const e=await this.$http({url:this.$http.adornUrl("admin/school/updateAdminSchool"),method:"post",data:this.ruleForm});if(console.log("response",e),e.data.code===500)throw u=e.data.msg,new Error(u);this.$message({message:"修改成功",type:"success",duration:1500}),this.reset(),this.$router.push("/schoolAdmin")}catch(e){console.error("请求数据失败:",u),this.$message.error(`${u||e}`),this.$router.push("/schoolAdmin")}}else{let u="";return Object.keys(i).forEach(e=>{i[e].forEach(s=>{u+=(s.message||s)+`!
`}),console.log("invalidFields[key]",i[e])}),this.$message.error(u.trim()),!1}})},async getAdminSchool(o){try{let i=(await this.$http({url:this.$http.adornUrl("admin/school/queryDesignateAdminSchool"),method:"get",params:{userId:o}})).data.data,u=[];i.sysUserRoleEntity.forEach(s=>{(s.roleName=="学校管理员"||s.roleName=="校区管理员")&&u.push(s.roleName)});let e=[];e=i.schoolVoList.map(s=>{let t=[];return s.schoolCampusVoList.forEach(r=>t.push({id:r.id})),{id:s.id,schoolCampusDto:t}}),this.manageRegionList.forEach(s=>{Array.isArray(s.campusIdList)||(s.campusIdList=[]);const t=e.find(r=>r.id===s.id);t&&(s.all=!0,t.schoolCampusDto&&t.schoolCampusDto.forEach(r=>{s.campusIdList.push(r.id)}))}),this.ruleForm={username:i.username,password:"",checkPass:"",mobile:i.mobile,email:i.email,status:!!i.status,roleIdList:u,schoolDtoList:e}}catch(l){console.error("请求数据失败:",l),this.$message.error("加载数据失败，请检查网络或稍后重试")}},async getRoleList(){try{let l=(await this.$http({url:this.$http.adornUrl("sys/role/selectRoleSchoolAndCampus"),method:"get"})).data.data;this.roleList=l}catch(o){console.error("请求数据失败:",o),this.$message.error("加载数据失败，请检查网络或稍后重试")}},async getSchoolList(){try{let l=(await this.$http({url:this.$http.adornUrl("admin/school/querySchoolAndSchoolCampus"),method:"get"})).data.data;l.forEach(i=>{i.all=!1,i.isIndeterminate=!1,i.campusIdList=[]}),this.manageRegionList=l}catch(o){console.error("请求数据失败:",o),this.$message.error("加载数据失败，请检查网络或稍后重试")}},updateIsBranchStatus(o){this.isBranch=o},updateEnableRegionStatus(o){this.enableRegion=o},handleAllChange(o){o.campusIdList=o.all?o.schoolCampusList.map(l=>l.id):[],o.isIndeterminate=!1},handleCheckedChange(o){let l=o.campusIdList.length;o.all=o.schoolCampusList.length===l,o.isIndeterminate=l>0&&l<o.schoolCampusList.length},reset(){this.ruleForm={username:"",password:"",checkPass:"",mobile:"",email:"",status:0,roleIdList:[],schoolDtoList:[]},this.manageRegionList.forEach(o=>{o.all=!1,o.isIndeterminate=!1,o.campusIdList=[]})}},watch:{"ruleForm.roleIdList":{handler(o,l){let i=!0,u=!0;o=="校区管理员"&&(i=!1,u=!1),o=="学校管理员"&&(u=!1,this.manageRegionList.forEach((e,s)=>{console.log(s,e),(e.isIndeterminate==!0||e.all==!0)&&(e.campusIdList=e.schoolCampusList.map(t=>t.id),e.all=!0,e.isIndeterminate=!1)})),this.updateIsBranchStatus(i),this.updateEnableRegionStatus(u)},deep:!0}},mounted(){this.getRoleList()},beforeRouteEnter(o,l,i){i(async u=>{u.reset(),await u.getSchoolList(),u.getAdminSchool(u.$route.query.userId)})},async beforeRouteUpdate(o,l,i){this.reset(),await this.getSchoolList(),this.getAdminSchool(this.$route.query.userId),i()}},y=o=>(R("data-v-9e0e66b6"),o=o(),S(),o),U=y(()=>F("fieldset",{class:"title"},[F("legend",null,"修改管理员")],-1)),D=y(()=>F("span",{class:"password-tip"},"注：手机号码是重要信息，需要用来接收短信验证码，请正确填写！",-1));function x(o,l,i,u,e,s){const t=c("el-input"),r=c("el-form-item"),m=c("el-checkbox"),_=c("el-checkbox-group"),w=c("el-switch"),C=c("el-button"),k=c("el-form");return p(),g("div",null,[U,n(k,{model:e.ruleForm,ref:"ruleForm",rules:e.rules,"label-width":"100px"},{default:d(()=>[n(r,{label:"账号",prop:"username"},{default:d(()=>[n(t,{modelValue:e.ruleForm.username,"onUpdate:modelValue":l[0]||(l[0]=a=>e.ruleForm.username=a),class:"input",placeholder:"管理员账号",disabled:""},null,8,["modelValue"])]),_:1}),n(r,{label:"密码",prop:"password"},{default:d(()=>[n(t,{modelValue:e.ruleForm.password,"onUpdate:modelValue":l[1]||(l[1]=a=>e.ruleForm.password=a),type:"password",class:"input",placeholder:"密码留空则不修改，密码需包含数字、字母、符号，且长度为6 - 20位"},null,8,["modelValue"])]),_:1}),n(r,{label:"确认密码",prop:"checkPass"},{default:d(()=>[n(t,{modelValue:e.ruleForm.checkPass,"onUpdate:modelValue":l[2]||(l[2]=a=>e.ruleForm.checkPass=a),type:"password",class:"input",placeholder:"密码留空则不修改，密码需包含数字、字母、符号，且长度为6 - 20位"},null,8,["modelValue"])]),_:1}),n(r,{label:"手机号码",prop:"mobile"},{default:d(()=>[n(t,{modelValue:e.ruleForm.mobile,"onUpdate:modelValue":l[3]||(l[3]=a=>e.ruleForm.mobile=a),class:"input",placeholder:"管理员手机号码"},null,8,["modelValue"]),D]),_:1}),n(r,{label:"邮箱",prop:"email"},{default:d(()=>[n(t,{modelValue:e.ruleForm.email,"onUpdate:modelValue":l[4]||(l[4]=a=>e.ruleForm.email=a),class:"input",placeholder:"管理员邮箱"},null,8,["modelValue"])]),_:1}),n(r,{label:"所属角色",prop:"roleIdList"},{default:d(()=>[n(_,{modelValue:e.ruleForm.roleIdList,"onUpdate:modelValue":l[5]||(l[5]=a=>e.ruleForm.roleIdList=a),max:1,class:"role"},{default:d(()=>[o.item.roleName=="学校管理员"||o.item.roleName=="校区管理员"?(p(!0),g(L,{key:0},b(e.roleList,a=>(p(),V(m,{label:a.roleName,key:a.roleId},{default:d(()=>[f(I(a.roleName),1)]),_:2},1032,["label"]))),128)):v("",!0)]),_:1},8,["modelValue"])]),_:1}),n(r,{label:"管理区域",prop:"schoolDtoList"},{default:d(()=>[(p(!0),g(L,null,b(e.manageRegionList,a=>(p(),g("div",{class:"manage-region",key:a.id},[n(m,{indeterminate:a.isIndeterminate,modelValue:a.all,"onUpdate:modelValue":h=>a.all=h,onChange:h=>s.handleAllChange(a),class:"manage-region-checkbox",disabled:e.enableRegion},{default:d(()=>[f(I(a.name),1)]),_:2},1032,["indeterminate","modelValue","onUpdate:modelValue","onChange","disabled"]),n(_,{modelValue:a.campusIdList,"onUpdate:modelValue":h=>a.campusIdList=h,onChange:h=>s.handleCheckedChange(a)},{default:d(()=>[(p(!0),g(L,null,b(a.schoolCampusList,h=>(p(),V(m,{class:"manage-region-checkbox-branch",key:h.id,label:h.id,disabled:e.isBranch},{default:d(()=>[f(I(h.name),1)]),_:2},1032,["label","disabled"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]))),128))]),_:1}),n(r,{label:"状态",prop:"status"},{default:d(()=>[n(w,{modelValue:e.ruleForm.status,"onUpdate:modelValue":l[6]||(l[6]=a=>e.ruleForm.status=a),"active-color":"#13ce66","active-text":"正常","inactive-text":"禁用","inactive-color":"#ff4949"},null,8,["modelValue"])]),_:1}),n(r,null,{default:d(()=>[n(C,{type:"info",onClick:l[7]||(l[7]=a=>s.submitForm("ruleForm"))},{default:d(()=>[f("立即提交")]),_:1})]),_:1})]),_:1},8,["model","rules"])])}const P=E(A,[["render",x],["__scopeId","data-v-9e0e66b6"]]);export{P as default};
