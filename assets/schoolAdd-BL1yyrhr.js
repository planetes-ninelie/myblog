import{_ as k,r as p,o as c,c as g,e as f,g as i,w as d,F as L,a as F,f as E,q as _,b as w,t as I,p as U,l as R}from"./index-DaiYPwGy.js";const S={data(){var e=(a,t,l)=>{t===""?l(new Error("请填写管理员账号")):l()},s=(a,t,l)=>{t===""?l(new Error("请输入密码")):t.length<6||t.length>20?l(new Error("请输入6-20位的密码")):(this.ruleForm.checkPass!==""&&this.$refs.ruleForm.validateField("checkPass"),l())},n=(a,t,l)=>{t===""?l(new Error("请再次输入密码")):t!==this.ruleForm.password?l(new Error("两次输入密码不一致!")):l()},u=(a,t,l)=>{!/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((.[a-zA-Z0-9_-]{2,3}){1,2})$/.test(t)&&t?l(new Error("邮箱格式不正确！")):l()},o=(a,t,l)=>{let m=/^1[0-9]{10}$/.test(t);console.log("re",m),!m&&t?l(new Error("手机号码格式不正确！")):l()};return{ruleForm:{username:"",password:"",checkPass:"",mobile:"",email:"",status:1,roleIdList:[],schoolDtoList:[],roleType:null},roleList:[],manageRegionList:[],rules:{username:[{validator:e,trigger:"blur"}],password:[{validator:s,trigger:"blur"}],checkPass:[{validator:n,trigger:"blur"}],roleIdList:[{type:"array",required:!0,message:"请至少选择一个所属角色",trigger:"change"}],email:[{validator:u,trigger:"blur"}],mobile:[{validator:o,trigger:"blur"}]},enableRegion:!0,isBranch:!0}},methods:{submitForm(e){this.$refs[e].validate(async(s,n)=>{if(s){let u="";try{this.ruleForm.schoolDtoList=[],await this.manageRegionList.forEach(a=>{if(a.all||a.isIndeterminate){let t={};if(this.ruleForm.roleIdList[0]==="校区管理员"){let l=[];a.campusIdList.forEach(m=>{l.push({id:m})}),t={id:a.id,schoolCampusDto:l}}this.ruleForm.roleIdList[0]==="学校管理员"&&(t={id:a.id}),this.ruleForm.schoolDtoList.push(t)}}),this.roleList.forEach(a=>{a.roleName===this.ruleForm.roleIdList[0]&&(this.ruleForm.roleIdList[0]=a.roleId)}),this.ruleForm.status=this.ruleForm.status?1:0,delete this.ruleForm.checkPass;const o=await this.$http({url:this.$http.adornUrl("admin/school/saveAdminSchool"),method:"post",data:this.ruleForm});if(o.data.code==500)throw u=o.data.msg,new Error(u);this.$message({message:"新增成功",type:"success",duration:1500}),this.reset(),this.$router.push("/schoolAdmin")}catch(o){console.error("请求数据失败:",u||o),this.$message.error(`${u||o}`),this.reset()}}else{let u="";return Object.keys(n).forEach(o=>{n[o].forEach(a=>{u+=(a.message||a)+`!
`}),console.log("invalidFields[key]",n[o])}),this.$message.error(u.trim()),!1}})},getUserInfo(){this.$http({url:this.$http.adornUrl("/sys/user/info"),method:"get"}).then(e=>{this.ruleForm.roleType=e.data.user.userType})},async getRoleList(){try{let s=(await this.$http({url:this.$http.adornUrl("sys/role/selectRoleSchoolAndCampus"),method:"get"})).data.data;this.roleList=s}catch(e){console.error("请求数据失败:",e),this.$message.error("加载数据失败，请检查网络或稍后重试")}},async getSchoolList(){try{let s=(await this.$http({url:this.$http.adornUrl("admin/school/querySchoolAndSchoolCampus"),method:"get"})).data.data;s.forEach(n=>{n.all=!1,n.isIndeterminate=!1,n.campusIdList=[]}),this.manageRegionList=s}catch(e){console.error("请求数据失败:",e),this.$message.error("加载数据失败，请检查网络或稍后重试")}},updateIsBranchStatus(e){this.isBranch=e},updateEnableRegionStatus(e){this.enableRegion=e},handleAllChange(e){e.campusIdList=e.all?e.schoolCampusList.map(s=>s.id):[],e.isIndeterminate=!1},handleCheckedChange(e){let s=e.campusIdList.length;e.all=e.schoolCampusList.length===s,e.isIndeterminate=s>0&&s<e.schoolCampusList.length},reset(){this.ruleForm={username:"",password:"",checkPass:"",mobile:"",email:"",status:1,roleIdList:[],schoolDtoList:[]},this.manageRegionList.forEach(e=>{e.all=!1,e.isIndeterminate=!1,e.campusIdList=[]})}},watch:{"ruleForm.roleIdList":{handler(e,s){let n=!0,u=!0;e=="校区管理员"&&(n=!1,u=!1),e=="学校管理员"&&(u=!1),this.updateIsBranchStatus(n),this.updateEnableRegionStatus(u)},deep:!0}},mounted(){this.getRoleList(),this.getSchoolList(),this.getUserInfo()},beforeRouteEnter(e,s,n){n(u=>{u.reset()})},beforeRouteUpdate(e,s,n){this.reset(),n()}},b=e=>(U("data-v-99675dc6"),e=e(),R(),e),x={class:"title"},A={key:0},P={key:1},B=b(()=>f("div",{class:"must"},"必填",-1)),D=b(()=>f("div",{class:"must"},"必填",-1)),N=b(()=>f("div",{class:"must"},"必填",-1)),T=b(()=>f("span",{class:"password-tip"},"注：手机号码是重要信息，需要用来接收短信验证码，请正确填写！",-1));function q(e,s,n,u,o,a){const t=p("el-input"),l=p("el-form-item"),m=p("el-checkbox"),V=p("el-checkbox-group"),y=p("el-switch"),v=p("el-button"),C=p("el-form");return c(),g("div",null,[f("fieldset",x,[o.ruleForm.roleType===1?(c(),g("legend",A,"添加管理员")):(c(),g("legend",P,"添加管理员"))]),i(C,{model:o.ruleForm,ref:"ruleForm",rules:o.rules,"label-width":"100px"},{default:d(()=>[i(l,{label:"账号",prop:"username"},{default:d(()=>[i(t,{modelValue:o.ruleForm.username,"onUpdate:modelValue":s[0]||(s[0]=r=>o.ruleForm.username=r),class:"input",placeholder:"管理员账号"},null,8,["modelValue"]),B]),_:1}),i(l,{label:"密码",prop:"password"},{default:d(()=>[i(t,{modelValue:o.ruleForm.password,"onUpdate:modelValue":s[1]||(s[1]=r=>o.ruleForm.password=r),type:"password",class:"input",placeholder:"密码需包含数字、字母、符号，且长度为6 - 20位"},null,8,["modelValue"]),D]),_:1}),i(l,{label:"确认密码",prop:"checkPass"},{default:d(()=>[i(t,{modelValue:o.ruleForm.checkPass,"onUpdate:modelValue":s[2]||(s[2]=r=>o.ruleForm.checkPass=r),type:"password",class:"input",placeholder:"密码需包含数字、字母、符号，且长度为6 - 20位"},null,8,["modelValue"]),N]),_:1}),i(l,{label:"手机号码",prop:"mobile"},{default:d(()=>[i(t,{modelValue:o.ruleForm.mobile,"onUpdate:modelValue":s[3]||(s[3]=r=>o.ruleForm.mobile=r),class:"input",placeholder:"管理员手机号码"},null,8,["modelValue"]),T]),_:1}),i(l,{label:"邮箱",prop:"email"},{default:d(()=>[i(t,{modelValue:o.ruleForm.email,"onUpdate:modelValue":s[4]||(s[4]=r=>o.ruleForm.email=r),class:"input",placeholder:"管理员邮箱"},null,8,["modelValue"])]),_:1}),i(l,{label:"所属角色",prop:"roleIdList"},{default:d(()=>[i(V,{modelValue:o.ruleForm.roleIdList,"onUpdate:modelValue":s[5]||(s[5]=r=>o.ruleForm.roleIdList=r),max:1,class:"role"},{default:d(()=>[e.item.roleName=="学校管理员"||e.item.roleName=="校区管理员"?(c(!0),g(L,{key:0},F(o.roleList,r=>(c(),w(m,{label:r.roleName,key:r.roleId},{default:d(()=>[_(I(r.roleName),1)]),_:2},1032,["label"]))),128)):E("",!0)]),_:1},8,["modelValue"])]),_:1}),i(l,{label:"管理区域",prop:"schoolDtoList"},{default:d(()=>[(c(!0),g(L,null,F(o.manageRegionList,r=>(c(),g("div",{class:"manage-region",key:r.id},[i(m,{indeterminate:r.isIndeterminate,modelValue:r.all,"onUpdate:modelValue":h=>r.all=h,onChange:h=>a.handleAllChange(r),class:"manage-region-checkbox",disabled:o.enableRegion},{default:d(()=>[_(I(r.name),1)]),_:2},1032,["indeterminate","modelValue","onUpdate:modelValue","onChange","disabled"]),i(V,{modelValue:r.campusIdList,"onUpdate:modelValue":h=>r.campusIdList=h,onChange:h=>a.handleCheckedChange(r)},{default:d(()=>[(c(!0),g(L,null,F(r.schoolCampusList,h=>(c(),w(m,{class:"manage-region-checkbox-branch",key:h.id,label:h.id,disabled:o.isBranch},{default:d(()=>[_(I(h.name),1)]),_:2},1032,["label","disabled"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]))),128))]),_:1}),i(l,{label:"状态",prop:"status"},{default:d(()=>[i(y,{modelValue:o.ruleForm.status,"onUpdate:modelValue":s[6]||(s[6]=r=>o.ruleForm.status=r),"active-color":"#13ce66","active-text":"正常","inactive-text":"禁用","inactive-color":"#ff4949"},null,8,["modelValue"])]),_:1}),i(l,null,{default:d(()=>[i(v,{type:"primary",onClick:s[7]||(s[7]=r=>a.submitForm("ruleForm"))},{default:d(()=>[_("立即提交")]),_:1})]),_:1})]),_:1},8,["model","rules"])])}const Z=k(S,[["render",q],["__scopeId","data-v-99675dc6"]]);export{Z as default};
