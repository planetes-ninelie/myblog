import{_ as A,r as p,o as h,c,e as F,t as f,g as u,w as d,f as L,F as I,a as _,s as b,b as V,p as k,l as E}from"./index-x_ALk9kT.js";const R={data(){var s=(r,t,l)=>{t===""?l(new Error("请填写管理员账号")):l()},o=(r,t,l)=>{t.length<6&&t.length>0||t.length>20?l(new Error("请输入6-20位的密码")):(this.ruleForm.checkPass!==""&&this.$refs.ruleForm.validateField("checkPass"),l())},i=(r,t,l)=>{t!==this.ruleForm.password?l(new Error("两次输入密码不一致!")):l()},n=(r,t,l)=>{!/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((.[a-zA-Z0-9_-]{2,3}){1,2})$/.test(t)&&t?l(new Error("邮箱格式不正确！")):l()},e=(r,t,l)=>{!/^1[0-9]{10}$/.test(t)&&t?l(new Error("手机号码格式不正确！")):l()};return{ruleForm:{username:"",password:"",checkPass:"",mobile:"",email:"",status:0,roleIdList:[],schoolDtoList:[],roleType:null},roleList:[],manageRegionList:[],rules:{username:[{validator:s,trigger:"blur"}],password:[{validator:o,trigger:"blur"}],checkPass:[{validator:i,trigger:"blur"}],roleIdList:[{type:"array",required:!0,message:"请至少选择一个所属角色",trigger:"change"}],email:[{validator:n,trigger:"blur"}],mobile:[{validator:e,trigger:"blur"}]},enableRegion:!0,isBranch:!0,isAmend:!0,placeholder:""}},methods:{submitForm(s){this.$refs[s].validate(async(o,i)=>{if(o)try{this.ruleForm.schoolDtoList=[],await this.manageRegionList.forEach(e=>{if(e.all||e.isIndeterminate){console.log(e);let r={};if(this.ruleForm.roleIdList[0]==="校区管理员"){let t=[];e.campusIdList.forEach(l=>{t.push({id:l})}),r={id:e.id,schoolCampusDto:t}}this.ruleForm.roleIdList[0]==="学校管理员"&&(r={id:e.id}),this.ruleForm.schoolDtoList.push(r)}}),this.ruleForm.status=this.ruleForm.status?1:0,this.ruleForm.userId=+this.$route.query.userId,await this.roleList.forEach(e=>{e.roleName===this.ruleForm.roleIdList[0]&&(this.ruleForm.roleIdList[0]=e.roleId)}),delete this.ruleForm.checkPass;let n={};if(this.isAmend){for(let e in this.ruleForm)(this.ruleForm[e]===void 0||this.ruleForm[e]===null)&&delete this.ruleForm[e];n=await this.$http({url:this.$http.adornUrl("admin/school/updateAdminSchool"),method:"post",data:this.ruleForm})}else n=await this.$http({url:this.$http.adornUrl("admin/school/saveAdminSchool"),method:"post",data:this.ruleForm});if(n.data.code===500){let e=n.data.msg;throw console.log("msg",e),new Error(e)}this.$message({message:`${this.isAmend?"修改成功":"新增成功"}`,type:"success",duration:1500}),this.reset(),this.$router.push("/frontEnd/testPages/schoolAdmin")}catch(n){console.error("请求数据失败:",n.message),this.$message.error(`${n.message||n}`),this.$router.push("/frontEnd/testPages//schoolAdmin")}else{let n="";return Object.keys(i).forEach(e=>{i[e].forEach(r=>{n+=(r.message||r)+`!
`}),console.log("invalidFields[key]",i[e])}),this.$message.error(n.trim()),!1}})},getUserInfo(){this.$http({url:this.$http.adornUrl("/sys/user/info"),method:"get"}).then(s=>{this.ruleForm.roleType=s.data.user.userType})},async getAdminSchool(s){try{let i=(await this.$http({url:this.$http.adornUrl("admin/school/queryDesignateAdminSchool"),method:"get",params:{userId:s}})).data.data,n=[];i.sysUserRoleEntity.forEach(r=>{(r.roleName=="学校管理员"||r.roleName=="校区管理员")&&n.push(r.roleName)});let e=[];e=i.schoolVoList.map(r=>{let t=[];return r.schoolCampusVoList.forEach(l=>t.push({id:l.id})),{id:r.id,schoolCampusDto:t}}),this.manageRegionList.forEach(r=>{Array.isArray(r.campusIdList)||(r.campusIdList=[]);const t=e.find(l=>l.id===r.id);t&&(r.all=!0,t.schoolCampusDto&&t.schoolCampusDto.forEach(l=>{r.campusIdList.push(l.id)}))}),this.ruleForm={username:i.username,password:"",checkPass:"",mobile:i.mobile,email:i.email,status:!!i.status,roleIdList:n,schoolDtoList:e}}catch(o){console.error("请求数据失败:",o),this.$message.error("加载数据失败，请检查网络或稍后重试")}},async getRoleList(){try{let o=(await this.$http({url:this.$http.adornUrl("sys/role/selectRoleSchoolAndCampus"),method:"get"})).data.data;this.roleList=o}catch(s){console.error("请求数据失败:",s),this.$message.error("加载数据失败，请检查网络或稍后重试")}},async getSchoolList(){try{let o=(await this.$http({url:this.$http.adornUrl("admin/school/querySchoolAndSchoolCampus"),method:"get"})).data.data;o.forEach(i=>{i.all=!1,i.isIndeterminate=!1,i.campusIdList=[]}),this.manageRegionList=o}catch(s){console.error("请求数据失败:",s),this.$message.error("加载数据失败，请检查网络或稍后重试")}},updateIsBranchStatus(s){this.isBranch=s},updateEnableRegionStatus(s){this.enableRegion=s},handleAllChange(s){s.campusIdList=s.all?s.schoolCampusList.map(o=>o.id):[],s.isIndeterminate=!1},handleCheckedChange(s){let o=s.campusIdList.length;s.all=s.schoolCampusList.length===o,s.isIndeterminate=o>0&&o<s.schoolCampusList.length},reset(){this.ruleForm={username:"",password:"",checkPass:"",mobile:"",email:"",status:0,roleIdList:[],schoolDtoList:[]},this.manageRegionList.forEach(s=>{s.all=!1,s.isIndeterminate=!1,s.campusIdList=[]})},async handleRouteChange(){this.reset(),await this.getSchoolList(),this.placeholder="密码需包含数字、字母、符号，且长度为6 - 20位",this.$route.query.userId?(await this.getAdminSchool(this.$route.query.userId),this.placeholder="密码留空则不修改，"+this.placeholder,this.isAmend=!0):this.isAmend=!1}},watch:{"ruleForm.roleIdList":{handler(s,o){let i=!0,n=!0;s=="校区管理员"&&(i=!1,n=!1),s=="学校管理员"&&(n=!1,this.manageRegionList.forEach((e,r)=>{console.log(r,e),(e.isIndeterminate==!0||e.all==!0)&&(e.campusIdList=e.schoolCampusList.map(t=>t.id),e.all=!0,e.isIndeterminate=!1)})),this.updateIsBranchStatus(i),this.updateEnableRegionStatus(n)},deep:!0}},mounted(){this.getRoleList(),this.getUserInfo()},beforeRouteEnter(s,o,i){i(n=>{n.handleRouteChange()})},beforeRouteUpdate(s,o,i){this.handleRouteChange().then(()=>i())}},U=s=>(k("data-v-625b58d3"),s=s(),E(),s),S={class:"title"},D={key:0,class:"must"},P={key:0,class:"must"},x={key:0,class:"must"},N=U(()=>F("span",{class:"password-tip"},"注：手机号码是重要信息，需要用来接收短信验证码，请正确填写！",-1));function B(s,o,i,n,e,r){const t=p("el-input"),l=p("el-form-item"),g=p("el-checkbox"),y=p("el-checkbox-group"),w=p("el-switch"),C=p("el-button"),v=p("el-form");return h(),c("div",null,[F("fieldset",S,[F("legend",null,f(e.isAmend?"修改管理员":"新增管理员"),1)]),u(v,{model:e.ruleForm,ref:"ruleForm",rules:e.rules,"label-width":"100px"},{default:d(()=>[u(l,{label:"账号",prop:"username"},{default:d(()=>[u(t,{modelValue:e.ruleForm.username,"onUpdate:modelValue":o[0]||(o[0]=a=>e.ruleForm.username=a),class:"input",placeholder:"管理员账号",disabled:e.isAmend},null,8,["modelValue","disabled"]),e.isAmend?L("",!0):(h(),c("div",D,"必填"))]),_:1}),u(l,{label:"密码",prop:"password"},{default:d(()=>[u(t,{modelValue:e.ruleForm.password,"onUpdate:modelValue":o[1]||(o[1]=a=>e.ruleForm.password=a),type:"password",class:"input",placeholder:e.placeholder},null,8,["modelValue","placeholder"]),e.isAmend?L("",!0):(h(),c("div",P,"必填"))]),_:1}),u(l,{label:"确认密码",prop:"checkPass"},{default:d(()=>[u(t,{modelValue:e.ruleForm.checkPass,"onUpdate:modelValue":o[2]||(o[2]=a=>e.ruleForm.checkPass=a),type:"password",class:"input",placeholder:e.placeholder},null,8,["modelValue","placeholder"]),e.isAmend?L("",!0):(h(),c("div",x,"必填"))]),_:1}),u(l,{label:"手机号码",prop:"mobile"},{default:d(()=>[u(t,{modelValue:e.ruleForm.mobile,"onUpdate:modelValue":o[3]||(o[3]=a=>e.ruleForm.mobile=a),class:"input",placeholder:"管理员手机号码"},null,8,["modelValue"]),N]),_:1}),u(l,{label:"邮箱",prop:"email"},{default:d(()=>[u(t,{modelValue:e.ruleForm.email,"onUpdate:modelValue":o[4]||(o[4]=a=>e.ruleForm.email=a),class:"input",placeholder:"管理员邮箱"},null,8,["modelValue"])]),_:1}),u(l,{label:"所属角色",prop:"roleIdList"},{default:d(()=>[u(y,{modelValue:e.ruleForm.roleIdList,"onUpdate:modelValue":o[5]||(o[5]=a=>e.ruleForm.roleIdList=a),max:1,class:"role"},{default:d(()=>[s.item.roleName=="学校管理员"||s.item.roleName=="校区管理员"?(h(!0),c(I,{key:0},_(e.roleList,a=>(h(),V(g,{label:a.roleName,key:a.roleId},{default:d(()=>[b(f(a.roleName),1)]),_:2},1032,["label"]))),128)):L("",!0)]),_:1},8,["modelValue"])]),_:1}),u(l,{label:"管理区域",prop:"schoolDtoList"},{default:d(()=>[(h(!0),c(I,null,_(e.manageRegionList,a=>(h(),c("div",{class:"manage-region",key:a.id},[u(g,{indeterminate:a.isIndeterminate,modelValue:a.all,"onUpdate:modelValue":m=>a.all=m,onChange:m=>r.handleAllChange(a),class:"manage-region-checkbox",disabled:e.enableRegion},{default:d(()=>[b(f(a.name),1)]),_:2},1032,["indeterminate","modelValue","onUpdate:modelValue","onChange","disabled"]),u(y,{modelValue:a.campusIdList,"onUpdate:modelValue":m=>a.campusIdList=m,onChange:m=>r.handleCheckedChange(a)},{default:d(()=>[(h(!0),c(I,null,_(a.schoolCampusList,m=>(h(),V(g,{class:"manage-region-checkbox-branch",key:m.id,label:m.id,disabled:e.isBranch},{default:d(()=>[b(f(m.name),1)]),_:2},1032,["label","disabled"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]))),128))]),_:1}),u(l,{label:"状态",prop:"status"},{default:d(()=>[u(w,{modelValue:e.ruleForm.status,"onUpdate:modelValue":o[6]||(o[6]=a=>e.ruleForm.status=a),"active-color":"#13ce66","active-text":"正常","inactive-text":"禁用","inactive-color":"#ff4949"},null,8,["modelValue"])]),_:1}),u(l,null,{default:d(()=>[u(C,{type:"success",onClick:o[7]||(o[7]=a=>r.submitForm("ruleForm"))},{default:d(()=>[b("立即提交")]),_:1})]),_:1})]),_:1},8,["model","rules"])])}const $=A(R,[["render",B],["__scopeId","data-v-625b58d3"]]);export{$ as default};
